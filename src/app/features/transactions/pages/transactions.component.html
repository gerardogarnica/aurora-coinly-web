<app-page-header>
  <form [formGroup]="transactionSearchForm" class="w-full">
    <div class="grid grid-cols-12 gap-3 md:gap-4">
      <div class="col-span-12 sm:col-span-6 lg:col-span-4 flex flex-col">
        <label for="rangeKey">Date Range</label>
        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
          <p-select
            id="rangeKey"
            formControlName="rangeKey"
            [options]="dateRangeOptions"
            optionLabel="label"
            optionValue="value"
            (onChange)="onDateRangeChange($event)"
            [filter]="true"
            panelStyleClass="select-panel-lg"
            styleClass="w-full"
            size="small" />
          <p-datepicker
            id="dateRange"
            formControlName="dateRange"
            selectionMode="range"
            size="small"
            dateFormat="dd/mm/yy"
            [readonlyInput]="true"
            (onSelect)="setDateRange('custom')"
            styleClass="w-full" />
        </div>
      </div>

      <div class="col-span-12 sm:col-span-6 md:col-span-3 flex flex-col">
        <label for="category">Category</label>
        <p-select
          id="category"
          placeholder="All"
          [showClear]="true"
          optionLabel="label"
          optionValue="value"
          [filter]="true"
          panelStyleClass="select-panel-lg"
          styleClass="w-full"
          size="small" />
      </div>

      <div class="col-span-12 sm:col-span-6 md:col-span-3 flex flex-col">
        <label for="paymentMethod">Payment Method</label>
        <p-select
          id="paymentMethod"
          formControlName="paymentMethodId"
          [options]="paymentMethodOptions()"
          placeholder="All"
          [showClear]="true"
          optionLabel="label"
          optionValue="value"
          [filter]="true"
          panelStyleClass="select-panel-lg"
          styleClass="w-full"
          size="small" />
      </div>

      <div class="col-span-12 lg:col-span-4 flex flex-col">
        <label for="status">Status</label>
        <div class="flex flex-wrap gap-3 mt-2">
          @for (status of statusOptions; track status) {
            <div class="flex items-center gap-2">
              <p-radiobutton
                formControlName="selectedStatus"
                name="selectedStatus"
                [inputId]="status.key"
                [value]="status.key" />
              <label [for]="status.key"> {{ status.name }} </label>
            </div>
          }
        </div>
      </div>

      <div class="col-span-12 lg:col-span-2 flex flex-col justify-end items-start lg:items-end">
        <p-button
          [label]="selectedTransactions().length > 0 ? 'Pay (' + selectedTransactions().length + ') selected pendings' : 'Pay pendings'"
          icon="pi pi-dollar"
          [title]="selectedTransactions().length > 0 ? 'Pay (' + selectedTransactions().length + ') selected pendings' : 'Pay pendings'"
          size="small"
          [raised]="true"
          (onClick)="onPayPendings()"
          [disabled]="selectedTransactions().length === 0"
        />
      </div>
    </div>
  </form>
</app-page-header>

<div class="space-y-2">
  @for (group of filteredGroupedTransactions(); track group.date) {
    <div class="space-y-2">
      <h2 class="font-bold text-lg text-coinly-primary mb-2">{{ group.date | date: 'fullDate' }}</h2>
      @for (transaction of group.transactions; track transaction.transactionId) {
        <div class="bg-white grid grid-cols-6 px-5 py-3 items-center rounded-2xl">
          <div class="col-span-2 flex items-center gap-3">
            <p-checkbox
              (onChange)="onTransactionSelectionChange($event.checked, transaction)"
              (checked)="isTransactionSelected(transaction)"
              [binary]="true"
              [disabled]="transaction.status === TransactionStatus.Paid" />
            <div>
              <p-avatar
                [icon]="getTransactionIcon(transaction)"
                shape="circle"
                [style]="{'background-color': `${transaction.category.color}66`, 'color': `${transaction.category.color}`}" />
            </div>
            <div class="flex flex-col">
              <span class="font-bold text-ellipsis">{{ transaction.description }}</span>
              <span class="text-xs text-coinly-disabled">{{ transaction.category.name }}</span>
            </div>
          </div>
          <div class="col-span-2 flex items-center gap-3">
            <div>
              <p-avatar
                [icon]="getTransactionWalletIcon(transaction.wallet.type)"
                shape="circle"
                [style]="{'background-color': `${transaction.wallet.color}66`, 'color': `${transaction.wallet.color}`}" />
            </div>
            <span class="font-bold">
              @if (isExpenseTransaction(transaction)) {
                {{ transaction.paymentMethod.name }}
              } @else {
                {{ transaction.wallet.name }}
              }
            </span>
          </div>
          <div class="flex flex-col items-center text-center">
            <p-tag
              [value]="transaction.status"
              [severity]="getTransactionStatusSeverity(transaction.status)"
              [rounded]="true" />
          </div>
          <span class="text-2xl content-center font-bold text-end" [ngClass]="getTransactionAmountClass(transaction)">
            {{ transaction.amount | currency: transaction.currency }}
          </span>
        </div>
      }
    </div>
  }
</div>

<p-confirmDialog [style]="{ width: '450px' }" />
<p-toast position="center" />

<app-pay-transactions-form
  [showDialog]="showPayTransactionDialog"
  [selectedTransactions]="selectedTransactions()"
  (cancelAction)="onPayPendingsDialogClose()">
</app-pay-transactions-form>
