<p-dialog
  header="Add New Transaction"
  [(visible)]="showDialog"
  [modal]="true"
  [style]="{ width: '40vw' }"
  [draggable]="false"
  [resizable]="false"
  [dismissableMask]="true"
  (onShow)="showDialogForm()"
  (onHide)="hideDialogForm()">
  <form [formGroup]="transactionForm" class="space-y-2" (ngSubmit)="onSave()">
    <div class="grid grid-cols-2">
      <p-button
        label="Expense"
        styleClass="w-full h-8 p-0"
        [severity]="transactionType === 'Expense' ? 'danger' : 'secondary'"
        [text]="transactionType === 'Income'"
        (onClick)="setTransactionType('Expense')" />
      <p-button 
        label="Income"
        styleClass="w-full h-8 p-0"
        [severity]="transactionType === 'Income' ? 'success' : 'secondary'"
        [text]="transactionType === 'Expense'"
        (onClick)="setTransactionType('Income')" />
    </div>

    @if (transactionType === 'Expense') {
      <div class="grid grid-cols-2 gap-4">
        <div class="flex flex-col">
          <label for="paymentMethodId">Payment Method</label>
          <p-select
            id="paymentMethodId"
            formControlName="paymentMethodId"
            [options]="paymentMethods"
            [checkmark]="true"
            optionLabel="name"
            optionValue="paymentMethodId"
            placeholder="Select a payment method"
            (onChange)="onPaymentMethodChange($event)"
            size="small" />
          @if (transactionForm.get('paymentMethodId')?.hasError('required') && transactionForm.get('paymentMethodId')?.touched) {
            <p class="text-red-500">Payment Method is required</p>
          }
        </div>

        <div class="flex items-center pt-5">
          <p-toggleswitch
            inputId="makePayment"
            formControlName="makePayment"
            (onChange)="onMakePaymentChange($event)" />
          <label for="makePayment" class="w-full ml-2">Make transaction payment</label>
        </div>
      </div>
    }

    <div class="grid grid-cols-2 gap-4">
      <div class="flex flex-col">
        <label for="walletId">Wallet</label>
        <p-select
          id="walletId"
          formControlName="walletId"
          [options]="wallets"
          [checkmark]="true"
          optionLabel="name"
          optionValue="walletId"
          placeholder="Select a wallet"
          (onChange)="onWalletChange($event)"
          size="small" />
        @if (transactionForm.get('walletId')?.hasError('required') && transactionForm.get('walletId')?.touched) {
          <p class="text-red-500">Wallet is required</p>
        }
      </div>

      <div class="flex flex-col">
        <label for="transactionDate">Date</label>
        <p-datepicker
          id="transactionDate"
          formControlName="transactionDate"
          size="small"
          [minDate]="transactionMinDate"
          [maxDate]="transactionMaxDate"
          [readonlyInput]="true"
          [showButtonBar]="true" />
        @if (transactionForm.get('transactionDate')?.hasError('required') && transactionForm.get('transactionDate')?.touched) {
          <p class="text-red-500">Date is required</p>
        }
      </div>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div class="flex flex-col">
        <label for="amount">Amount</label>
        <p-input-number
          inputId="amount"
          formControlName="amount"
          mode="decimal"
          [min]="0.01"
          [max]="amountMax"
          [minFractionDigits]="2"
          [maxFractionDigits]="2"
          size="small"
          fluid />
        @if (transactionForm.get('amount')?.hasError('required') && transactionForm.get('amount')?.touched) {
          <p class="text-red-500">Amount is required</p>
        }
      </div>

      <div class="flex flex-col">
        <label for="categoryId">Category</label>
        <p-select
          id="categoryId"
          formControlName="categoryId"
          [options]="categoriesByType"
          [checkmark]="true"
          optionLabel="name"
          optionValue="categoryId"
          placeholder="Select a category"
          size="small" />
        @if (transactionForm.get('categoryId')?.hasError('required') && transactionForm.get('categoryId')?.touched) {
          <p class="mt-1 text-coinly-danger">Category is required</p>
        }
      </div>
    </div>

    <div class="flex flex-col">
      <label for="description">Description <span class="text-coinly-info">(required, 3-100 characters)</span></label>
      <input
        pInputText
        id="description"
        formControlName="description"
        placeholder="Enter description"
        maxlength="100"
        variant="outlined"
        pSize="small" />
      @if (transactionForm.get('description')?.hasError('required') && transactionForm.get('description')?.touched) {
        <p class="mt-1 text-coinly-danger">Description is required</p>
      }
      @if (transactionForm.get('description')?.hasError('minlength')) {
        <p class="mt-1 text-coinly-danger">Description must be at least 3 characters</p>
      }
      @if (transactionForm.get('description')?.hasError('maxlength')) {
        <p class="mt-1 text-coinly-danger">Description cannot exceed 100 characters</p>
      }
    </div>

    <div class="flex flex-col">
      <label for="notes">Notes</label>
      <textarea
        pTextarea
        id="notes"
        formControlName="notes"
        rows="6"
        placeholder="Enter any additional notes"
        maxlength="1000"
        pSize="small"></textarea>
      @if (transactionForm.get('notes')?.hasError('maxlength')) {
        <p class="mt-1 text-coinly-danger">Notes cannot exceed 1,000 characters</p>
      }
    </div>

    <div class="flex justify-end pt-8 gap-2">
      <p-button
        label="Cancel"
        icon="pi pi-times"
        severity="danger"
        size="small"
        (click)="showDialog = false" />
      <p-button
        label="Save"
        icon="pi pi-save"
        severity="success"
        size="small"
        [disabled]="!transactionForm.valid || this.processStatus === 'loading'"
        (click)="onSave()" />
    </div>
  </form>
</p-dialog>

<p-confirmDialog [style]="{ width: '450px' }" />
<p-toast position="center" />
